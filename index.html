<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Semanal IA - Bunyola</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0b0b0f;
            color: #F5F7FA;
            overflow-x: auto;
            min-height: 100vh;
        }

        /* Gate de acceso */
        .access-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 15, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .access-form {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 255, 255, 0.1);
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .access-form h2 {
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .access-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            color: #F5F7FA;
            font-size: 16px;
        }

        .access-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .access-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 255, 255, 0.3);
        }

        /* Header */
        .header {
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .week-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.3);
        }

        .week-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            flex: 1;
        }

        .quick-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: glow-pulse 2s infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .quick-btn.work {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            background-size: 200% 200%;
        }

        .quick-btn.gym {
            background: linear-gradient(45deg, #4834d4, #686de0);
            background-size: 200% 200%;
        }

        .quick-btn.study {
            background: linear-gradient(45deg, #00d2d3, #01a3a4);
            background-size: 200% 200%;
        }

        .quick-btn.meal {
            background: linear-gradient(45deg, #ff9ff3, #f368e0);
            background-size: 200% 200%;
        }

        .quick-btn.sleep {
            background: linear-gradient(45deg, #3742fa, #2f3542);
            background-size: 200% 200%;
        }

        .quick-btn.clean {
            background: linear-gradient(45deg, #7bed9f, #5f27cd);
            background-size: 200% 200%;
        }

        .quick-btn.free {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            background-size: 200% 200%;
        }

        .quick-btn.audio {
            background: linear-gradient(45deg, #ff3838, #ff6b35);
            background-size: 200% 200%;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.2);
        }

        .info-chips {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .chip {
            padding: 5px 12px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
        }

        /* Calendario */
        .calendar-container {
            padding: 20px;
            overflow-x: auto;
            min-width: 800px;
        }

        .calendar {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            grid-template-rows: 40px repeat(17, 56px);
            gap: 1px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .time-header, .day-header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .time-slot, .day-cell {
            background: rgba(11, 11, 15, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .day-cell:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        .time-slot {
            font-weight: bold;
            color: rgba(245, 247, 250, 0.7);
        }

        /* Eventos */
        .events {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            grid-template-rows: 40px repeat(17, 56px);
            gap: 1px;
        }

        .event {
            pointer-events: all;
            border-radius: 12px;
            padding: 8px;
            margin: 2px;
            cursor: move;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .event:hover {
            transform: scale(1.02);
            filter: saturate(1.2);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
        }

        .event.work {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .event.gym {
            background: linear-gradient(135deg, #4834d4, #686de0);
            box-shadow: 0 0 20px rgba(72, 52, 212, 0.3);
        }

        .event.study {
            background: linear-gradient(135deg, #00d2d3, #01a3a4);
            box-shadow: 0 0 20px rgba(0, 210, 211, 0.3);
        }

        .event.meal {
            background: linear-gradient(135deg, #ff9ff3, #f368e0);
            box-shadow: 0 0 20px rgba(255, 159, 243, 0.3);
        }

        .event.sleep {
            background: linear-gradient(135deg, #3742fa, #2f3542);
            box-shadow: 0 0 20px rgba(55, 66, 250, 0.3);
        }

        .event.clean {
            background: linear-gradient(135deg, #7bed9f, #5f27cd);
            box-shadow: 0 0 20px rgba(123, 237, 159, 0.3);
        }

        .event.free {
            background: linear-gradient(135deg, #ffa502, #ff6348);
            box-shadow: 0 0 20px rgba(255, 165, 2, 0.3);
        }

        .event.audio {
            background: linear-gradient(135deg, #ff3838, #ff6b35);
            box-shadow: 0 0 20px rgba(255, 56, 56, 0.3);
        }

        .event-title {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .event-time {
            font-size: 10px;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
            animation: fade-in 0.3s ease;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.3);
            min-width: 400px;
            max-width: 90vw;
        }

        .modal h3 {
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #F5F7FA;
            font-size: 14px;
        }

        .form-group select option {
            background: #1a1a2e;
            color: #F5F7FA;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #F5F7FA;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(255, 255, 255, 0.2);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 10px;
                min-width: 100%;
            }
            
            .quick-buttons {
                justify-content: center;
            }
            
            .modal-content {
                min-width: 90vw;
                padding: 20px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Gate de acceso -->
    <div class="access-gate" id="accessGate">
        <div class="access-form">
            <h2>üîê Acceso Calendario IA</h2>
            <input type="password" class="access-input" id="passwordInput" placeholder="Contrase√±a de acceso">
            <button class="access-btn" onclick="checkAccess()">Acceder</button>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div class="app hidden" id="mainApp">
        <!-- Header -->
        <div class="header">
            <div class="week-navigation">
                <button class="nav-btn" onclick="changeWeek(-1)">‚¨ÖÔ∏è Semana Anterior</button>
                <div class="week-title" id="weekTitle">üìÖ Semana del 13-19 Enero 2025</div>
                <button class="nav-btn" onclick="changeWeek(1)">Semana Siguiente ‚û°Ô∏è</button>
            </div>
            
            <div class="quick-buttons">
                <button class="quick-btn work" onclick="quickAdd('work')">üíº Trabajo IA</button>
                <button class="quick-btn gym" onclick="quickAdd('gym')">üí™ Gimnasio</button>
                <button class="quick-btn study" onclick="quickAdd('study')">üìö Estudio</button>
                <button class="quick-btn meal" onclick="quickAdd('meal')">üçΩÔ∏è Meal Prep</button>
                <button class="quick-btn sleep" onclick="quickAdd('sleep')">üò¥ Sue√±o</button>
                <button class="quick-btn clean" onclick="quickAdd('clean')">üßπ Limpieza</button>
                <button class="quick-btn free" onclick="quickAdd('free')">üéØ Tiempo Libre</button>
                <button class="quick-btn audio" onclick="quickAdd('audio')">üéµ Audio/M√∫sica</button>
            </div>

            <div class="info-chips">
                <div class="chip" id="weekInfo">üìä 7 d√≠as planificados</div>
                <div class="chip">‚ö° Sincronizaci√≥n activa</div>
                <div class="chip">üé® Tema ne√≥n</div>
                <div class="chip" id="audioStatus">üîá Audio: Deshabilitado</div>
            </div>
        </div>

        <!-- Calendario -->
        <div class="calendar-container">
            <div class="calendar" id="calendar">
                <!-- Headers -->
                <div class="time-header">Hora</div>
                <div class="day-header">Lun</div>
                <div class="day-header">Mar</div>
                <div class="day-header">Mi√©</div>
                <div class="day-header">Jue</div>
                <div class="day-header">Vie</div>
                <div class="day-header">S√°b</div>
                <div class="day-header">Dom</div>

                <!-- Time slots y celdas del calendario se generan din√°micamente -->
            </div>
            
            <!-- Capa de eventos -->
            <div class="events" id="eventsLayer"></div>
        </div>
    </div>

    <!-- Modal de edici√≥n -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <h3 id="modalTitle">Crear Evento</h3>
            <form id="eventForm">
                <div class="form-group">
                    <label>T√≠tulo:</label>
                    <input type="text" id="eventTitleInput" required>
                </div>
                
                <div class="form-group">
                    <label>D√≠a:</label>
                    <select id="eventDay">
                        <option value="0">Lunes</option>
                        <option value="1">Martes</option>
                        <option value="2">Mi√©rcoles</option>
                        <option value="3">Jueves</option>
                        <option value="4">Viernes</option>
                        <option value="5">S√°bado</option>
                        <option value="6">Domingo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Hora inicio:</label>
                    <select id="eventHour"></select>
                </div>
                
                <div class="form-group">
                    <label>Duraci√≥n (horas):</label>
                    <select id="eventDuration">
                        <option value="0.5">30 min</option>
                        <option value="1">1 hora</option>
                        <option value="1.5">1.5 horas</option>
                        <option value="2">2 horas</option>
                        <option value="3">3 horas</option>
                        <option value="4">4 horas</option>
                        <option value="8">8 horas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Categor√≠a:</label>
                    <select id="eventCategory" onchange="toggleAudioOptions()">
                        <option value="work">üíº Trabajo</option>
                        <option value="gym">üí™ Gimnasio</option>
                        <option value="study">üìö Estudio</option>
                        <option value="meal">üçΩÔ∏è Comida</option>
                        <option value="sleep">üò¥ Sue√±o</option>
                        <option value="clean">üßπ Limpieza</option>
                        <option value="free">üéØ Libre</option>
                        <option value="audio">üéµ Audio/M√∫sica</option>
                    </select>
                </div>
                
                <div class="form-group audio-options" id="audioOptions" style="display: none;">
                    <label>üéµ Opciones de Audio:</label>
                    <select id="audioType">
                        <option value="music">üé∂ M√∫sica de fondo</option>
                        <option value="podcast">üéôÔ∏è Podcast</option>
                        <option value="audiobook">üìñ Audiolibro</option>
                        <option value="meditation">üßò Meditaci√≥n</option>
                        <option value="nature">üåø Sonidos naturales</option>
                        <option value="focus">üéØ M√∫sica de concentraci√≥n</option>
                    </select>
                </div>
                
                <div class="form-group audio-options" id="audioUrl" style="display: none;">
                    <label>üîó URL de Audio (opcional):</label>
                    <input type="url" id="audioUrlInput" placeholder="https://ejemplo.com/audio.mp3">
                    <small style="color: rgba(245, 247, 250, 0.7); font-size: 12px;">
                        ‚ö†Ô∏è Nota: La reproducci√≥n de audio no est√° disponible por limitaciones t√©cnicas, pero se guardar√° la referencia.
                    </small>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteEvent()" style="display: none;">Eliminar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Variables globales
        let EVENTS = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        let currentEditingEvent = null;
        let draggedEvent = null;
        let currentWeekOffset = 0; // 0 = semana actual, -1 = anterior, +1 = siguiente

        // Verificar acceso
        function checkAccess() {
            const password = document.getElementById('passwordInput').value;
            if (password === 'Bunyola20') {
                sessionStorage.setItem('calendarAccess', 'granted');
                document.getElementById('accessGate').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initCalendar();
            } else {
                alert('‚ùå Contrase√±a incorrecta');
            }
        }

        // Verificar acceso al cargar
        window.onload = function() {
            if (sessionStorage.getItem('calendarAccess') === 'granted') {
                document.getElementById('accessGate').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initCalendar();
            }
        };

        // Inicializar calendario
        function initCalendar() {
            generateCalendarGrid();
            generateHourOptions();
            updateWeekTitle();
            renderEvents();
            setupEventListeners();
        }

        // Actualizar t√≠tulo de semana
        function updateWeekTitle() {
            const today = new Date();
            const currentMonday = new Date(today);
            currentMonday.setDate(today.getDate() - today.getDay() + 1); // Lunes de esta semana
            
            // Ajustar por offset de semana
            currentMonday.setDate(currentMonday.getDate() + (currentWeekOffset * 7));
            
            const sunday = new Date(currentMonday);
            sunday.setDate(currentMonday.getDate() + 6);
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const startDay = currentMonday.getDate();
            const endDay = sunday.getDate();
            const startMonth = months[currentMonday.getMonth()];
            const endMonth = months[sunday.getMonth()];
            const year = currentMonday.getFullYear();
            
            let weekText;
            if (startMonth === endMonth) {
                weekText = `üìÖ Semana del ${startDay}-${endDay} ${startMonth} ${year}`;
            } else {
                weekText = `üìÖ Semana del ${startDay} ${startMonth} - ${endDay} ${endMonth} ${year}`;
            }
            
            document.getElementById('weekTitle').textContent = weekText;
            
            // Actualizar info chip
            const weekInfo = document.getElementById('weekInfo');
            if (currentWeekOffset === 0) {
                weekInfo.textContent = 'üìä Semana actual';
            } else if (currentWeekOffset < 0) {
                weekInfo.textContent = `üìä ${Math.abs(currentWeekOffset)} semana(s) atr√°s`;
            } else {
                weekInfo.textContent = `üìä ${currentWeekOffset} semana(s) adelante`;
            }
        }

        // Cambiar semana
        function changeWeek(direction) {
            currentWeekOffset += direction;
            updateWeekTitle();
            
            // Cargar eventos de la semana correspondiente
            const weekKey = `calendarEvents_week_${currentWeekOffset}`;
            EVENTS = JSON.parse(localStorage.getItem(weekKey) || '[]');
            renderEvents();
        }

        // Generar grid del calendario
        function generateCalendarGrid() {
            const calendar = document.getElementById('calendar');
            
            // Generar slots de tiempo y celdas
            for (let hour = 6; hour <= 22; hour++) {
                // Slot de tiempo
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                calendar.appendChild(timeSlot);
                
                // Celdas de d√≠as
                for (let day = 0; day < 7; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.dataset.day = day;
                    dayCell.dataset.hour = hour;
                    dayCell.addEventListener('click', () => openModal(day, hour));
                    calendar.appendChild(dayCell);
                }
            }
        }

        // Generar opciones de hora
        function generateHourOptions() {
            const hourSelect = document.getElementById('eventHour');
            for (let hour = 6; hour <= 22; hour++) {
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = `${hour.toString().padStart(2, '0')}:00`;
                hourSelect.appendChild(option);
            }
        }

        // Renderizar eventos
        function renderEvents() {
            const eventsLayer = document.getElementById('eventsLayer');
            eventsLayer.innerHTML = '';

            EVENTS.forEach((event, index) => {
                const eventElement = document.createElement('div');
                eventElement.className = `event ${event.category}`;
                eventElement.draggable = true;
                eventElement.dataset.index = index;
                
                // Calcular posici√≥n y tama√±o
                const gridRow = event.hour - 5; // Ajuste por header
                const gridColumn = event.day + 2; // Ajuste por columna de horas
                const rowSpan = event.duration * 2; // 2 filas por hora (56px cada una)
                
                eventElement.style.gridRow = `${gridRow} / span ${rowSpan}`;
                eventElement.style.gridColumn = gridColumn;
                
                let eventContent = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-time">${event.hour}:00 - ${event.hour + event.duration}:00</div>
                `;
                
                // Agregar info de audio si es categor√≠a audio
                if (event.category === 'audio' && event.audioType) {
                    const audioTypes = {
                        music: 'üé∂', podcast: 'üéôÔ∏è', audiobook: 'üìñ',
                        meditation: 'üßò', nature: 'üåø', focus: 'üéØ'
                    };
                    const icon = audioTypes[event.audioType] || 'üéµ';
                    eventContent += `<div style="font-size: 10px; opacity: 0.8;">${icon} ${event.audioType}</div>`;
                }
                
                eventElement.innerHTML = eventContent;
                
                // Event listeners
                eventElement.addEventListener('dblclick', () => editEvent(index));
                eventElement.addEventListener('dragstart', handleDragStart);
                eventElement.addEventListener('dragend', handleDragEnd);
                
                eventsLayer.appendChild(eventElement);
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Drag and drop
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('drop', handleDrop);
            
            // Form submit
            document.getElementById('eventForm').addEventListener('submit', saveEvent);
            
            // Tooltips
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.addEventListener('mouseenter', showTooltip);
                cell.addEventListener('mouseleave', hideTooltip);
            });
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            draggedEvent = parseInt(e.target.dataset.index);
            e.target.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedEvent = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.day-cell');
            if (target && draggedEvent !== null) {
                const newDay = parseInt(target.dataset.day);
                const newHour = parseInt(target.dataset.hour);
                
                // Actualizar evento
                EVENTS[draggedEvent].day = newDay;
                EVENTS[draggedEvent].hour = newHour;
                
                saveToStorage();
                renderEvents();
            }
        }

        // Modal functions
        function openModal(day = 0, hour = 9, eventIndex = null) {
            currentEditingEvent = eventIndex;
            const modal = document.getElementById('eventModal');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteBtn');
            
            if (eventIndex !== null) {
                // Editar evento existente
                const event = EVENTS[eventIndex];
                title.textContent = 'Editar Evento';
                document.getElementById('eventTitleInput').value = event.title;
                document.getElementById('eventDay').value = event.day;
                document.getElementById('eventHour').value = event.hour;
                document.getElementById('eventDuration').value = event.duration;
                document.getElementById('eventCategory').value = event.category;
                
                // Cargar datos de audio si existen
                if (event.category === 'audio') {
                    document.getElementById('audioType').value = event.audioType || 'music';
                    document.getElementById('audioUrlInput').value = event.audioUrl || '';
                }
                
                toggleAudioOptions();
                deleteBtn.style.display = 'inline-block';
            } else {
                // Crear nuevo evento
                title.textContent = 'Crear Evento';
                document.getElementById('eventForm').reset();
                document.getElementById('eventDay').value = day;
                document.getElementById('eventHour').value = hour;
                deleteBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
            currentEditingEvent = null;
        }

        function editEvent(index) {
            const event = EVENTS[index];
            openModal(event.day, event.hour, index);
        }

        function saveEvent(e) {
            e.preventDefault();
            
            const eventData = {
                title: document.getElementById('eventTitleInput').value,
                day: parseInt(document.getElementById('eventDay').value),
                hour: parseInt(document.getElementById('eventHour').value),
                duration: parseFloat(document.getElementById('eventDuration').value),
                category: document.getElementById('eventCategory').value
            };
            
            // Agregar datos de audio si es categor√≠a audio
            if (eventData.category === 'audio') {
                eventData.audioType = document.getElementById('audioType').value;
                eventData.audioUrl = document.getElementById('audioUrlInput').value;
            }
            
            if (currentEditingEvent !== null) {
                EVENTS[currentEditingEvent] = eventData;
            } else {
                EVENTS.push(eventData);
            }
            
            saveToStorage();
            renderEvents();
            closeModal();
        }

        function deleteEvent() {
            if (currentEditingEvent !== null) {
                EVENTS.splice(currentEditingEvent, 1);
                saveToStorage();
                renderEvents();
                closeModal();
            }
        }

        // Toggle audio options
        function toggleAudioOptions() {
            const category = document.getElementById('eventCategory').value;
            const audioOptions = document.querySelectorAll('.audio-options');
            
            if (category === 'audio') {
                audioOptions.forEach(option => option.style.display = 'block');
            } else {
                audioOptions.forEach(option => option.style.display = 'none');
            }
        }

        // Quick add functions
        function quickAdd(category) {
            const presets = {
                work: { title: 'Trabajo IA', duration: 1 },
                gym: { title: 'Gimnasio', duration: 1.5 },
                study: { title: 'Estudio', duration: 2 },
                meal: { title: 'Meal Prep', duration: 1 },
                sleep: { title: 'Sue√±o', duration: 8 },
                clean: { title: 'Limpieza', duration: 1 },
                free: { title: 'Tiempo Libre', duration: 2 },
                audio: { title: 'Sesi√≥n de Audio', duration: 1 }
            };
            
            const preset = presets[category];
            openModal(0, 9);
            
            // Aplicar preset
            setTimeout(() => {
                document.getElementById('eventTitleInput').value = preset.title;
                document.getElementById('eventDuration').value = preset.duration;
                document.getElementById('eventCategory').value = category;
                toggleAudioOptions();
            }, 100);
        }

        // Tooltip functions
        function showTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            const day = parseInt(e.target.dataset.day);
            const hour = parseInt(e.target.dataset.hour);
            const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            
            tooltip.textContent = `Clic para a√±adir en ${days[day]} ${hour}:00`;
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.style.top = e.pageY - 30 + 'px';
            tooltip.style.opacity = '1';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = '0';
        }

        // Storage functions
        function saveToStorage() {
            const weekKey = `calendarEvents_week_${currentWeekOffset}`;
            localStorage.setItem(weekKey, JSON.stringify(EVENTS));
            
            // Tambi√©n guardar en la clave general para compatibilidad
            if (currentWeekOffset === 0) {
                localStorage.setItem('calendarEvents', JSON.stringify(EVENTS));
            }
        }

        // Export function
        function exportCalendar() {
            const dataStr = JSON.stringify(EVENTS, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'calendario_semanal.json';
            link.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9720d40b539f9600',t:'MTc1NTY4MTc2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
